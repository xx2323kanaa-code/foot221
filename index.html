<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Ankle Dorsi/Plantar Flexion Counter</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

<style>
body{
  margin:0;
  background:#fff;
  color:#000;
  font-family:system-ui, sans-serif;
}
#title{ padding:6px; font-weight:bold; }
#countNow{ font-size:24px; padding:6px; }
#video{
  width:100vw;
  height:60vh;
  object-fit:cover;
  background:#000;
}
#panel{
  position:fixed;
  bottom:0; left:0; right:0;
  background:#f0f0f0;
  border-top:1px solid #999;
}
button, select{
  margin:4px;
  padding:6px;
}
#status{
  padding:4px 6px;
  font-size:13px;
  color:#111;
}
#hud{
  display:none;
  font-size:12px;
  max-height:180px;
  overflow:auto;
  white-space:pre;
  border-top:1px dashed #999;
  padding:4px;
}
#intro{
  padding:8px 10px;
  background:#fff9f0;
  border-bottom:1px solid #e0c080;
  font-size:14px;
  line-height:1.5;
  margin-bottom:4px;
}
#intro ol{
  margin:4px 0 0 18px;
  padding:0;
}
#extraArea{
  padding:6px;
  font-size:13px;
}
#extraControls{
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  gap:6px;
  margin-bottom:6px;
}
#extraControls>button,#extraControls>select{
  padding:6px 10px;
  border-radius:4px;
  border:1px solid #999;
  background:#fff;
}
#historyChart{
  width:100%;
  max-width:100%;
  border:1px solid #ccc;
  background:#f9f9f9;
}
#graphMessage,#distanceMessage{
  margin-top:4px;
  color:#1a1a1a;
}
</style>
</head>

<body>

<div id="title">Ankle Dorsi/Plantar Flexion Counter / è¶³é–¢ç¯€åº•èƒŒå±ˆã‚«ã‚¦ãƒ³ã‚¿ãƒ¼</div>
<div id="countNow">Now: 0 / ç¾åœ¨: 0</div>
<div id="intro">
  <strong>ã“ã®ã‚¢ãƒ—ãƒªã¯è¶³é–¢ç¯€ã®åº•èƒŒå±ˆã‚’ä¿ƒã—ã€ä¸‹è…¿éƒ¨å…¨ä½“ã®å¥åº·ã‚’æ”¯æ´ã™ã‚‹ã‚ˆã†è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚</strong>
  <ol>
    <li>è¶³ã®ã‚€ãã¿ã‚’è»½æ¸›ã—ã€</li>
    <li>ã€Œç¬¬äºŒã®å¿ƒè‡“ã€ã¨å‘¼ã°ã‚Œã‚‹ä¸‹è…¿ç­‹ã‚’å¼·åŒ–ã—ã€</li>
    <li>å·¦å³äº¤äº’ã®ãƒªã‚ºãƒŸã‚«ãƒ«ãªå‹•ä½œã§è„³ã®æ„Ÿè¦šãƒ»é‹å‹•ã‚’å”èª¿ã•ã›ã¾ã™ã€‚</li>
  </ol>
  ï¼‘ã‚»ãƒƒãƒˆï¼’ï¼å›ã‚’ç›®å®‰ã«ã€æœ€å¤§ï¼‘æ—¥ï¼˜ï¼ï¼å›ã¾ã§æŒ‘æˆ¦ã—ã¦ãã ã•ã„ã€‚
</div>

<video id="video" autoplay muted playsinline></video>

<div id="panel">
  <button id="startBtn">ğŸ“· Start Camera / ã‚«ãƒ¡ãƒ©èµ·å‹•</button>

  <select id="facing">
    <option value="user">Front / å‰å´</option>
    <option value="environment">Back / èƒŒé¢</option>
  </select>

  <button id="modeBtn">ğŸ¦¶ Barefoot / è£¸è¶³</button>
  <button id="hudBtn">HUD / HUDè¡¨ç¤º</button>
  <button id="copyHudBtn">ğŸ“‹ Copy HUD / HUDã‚³ãƒ”ãƒ¼</button>
  <button id="csvBtn">CSV / CSVä¸€æ‹¬å‡ºåŠ›</button>

  <div id="hud"></div>
</div>
<div id="status" aria-live="polite"></div>
<div id="extraArea">
  <div id="extraControls">
    <button id="plotBtn">è¨ºå¯Ÿæ™‚ã‚°ãƒ©ãƒ•åŒ–</button>
    <button id="distanceBtn">æ±æµ·é“æ›ç®—</button>
    <label for="startPointSelect">å‡ºç™ºç‚¹:</label>
    <select id="startPointSelect">
      <option value="nihonbashi">æ—¥æœ¬æ©‹èµ·ç‚¹</option>
      <option value="sanjo">ä¸‰æ¡å¤§æ©‹èµ·ç‚¹</option>
    </select>
  </div>
  <canvas id="historyChart" width="320" height="180" aria-label="éå»7æ—¥é–“ã®å®Ÿæ–½å›æ•°"></canvas>
  <div id="graphMessage"></div>
  <div id="distanceMessage"></div>
</div>

<script>
  
  /* ===== åŸºæœ¬DOM ===== */
const video = document.getElementById("video");
const countNow = document.getElementById("countNow");
const hud = document.getElementById("hud");
const status = document.getElementById("status");
const intro = document.getElementById("intro");

/* ===== ãƒ¢ãƒ¼ãƒ‰ç®¡ç† ===== */
let socksMode = false;
function logModeChange(){
  const label = socksMode ? "ğŸ§¦ Socks / é´ä¸‹" : "ğŸ¦¶ Barefoot / è£¸è¶³";
  logs.push(`=== MODE CHANGE: ${label} ===`);
}

/* ===== ãƒ¢ãƒ‡ãƒ«ãƒ»çŠ¶æ…‹ ===== */
let model=null, stream=null, running=false;
let lastFootY=null, lastEventTime=0, lastSign=null, armed=false;
let sessionCount=0, logs=[];
let sessionModeCounts={barefoot:0,socks:0};
let starTimes=[];

const MAX_LOGS=300;

/* ---- tuningï¼ˆè£¸è¶³åŸºæº–ãƒ»æ¸©å­˜ï¼‰ ---- */
const THRESH_ON=6;
const THRESH_OFF=3;
const LOCK_MS=800;
const JUMP_CUT=120;

/* ---- é´ä¸‹ãƒ¢ãƒ¼ãƒ‰è£œæ­£ï¼ˆè¿½è¨˜ï¼‰ ---- */
function getThresholds(){
  if(socksMode){
    return {
      THRESH_ON: 10,
      THRESH_OFF: 5,
      JUMP_CUT: 180
    };
  }
  return {
    THRESH_ON,
    THRESH_OFF,
    JUMP_CUT
  };
}

/* ---- daily storage ---- */
const todayKey = new Date().toISOString().slice(0,10);
const rawHistory = JSON.parse(localStorage.getItem("ankleHistory")||"{}");
const history = {};
for(const [day, record] of Object.entries(rawHistory)){
  history[day] = normalizeRecord(record);
}

function normalizeRecord(record){
  if(typeof record==="number"){
    return {total:record,barefoot:0,socks:0};
  }
  return {
    total: record?.total || 0,
    barefoot: record?.barefoot || 0,
    socks: record?.socks || 0
  };
}

const tokaidoStations = [
  {name:"Nihonbashi (æ—¥æœ¬æ©‹)", distance:0},
  {name:"Shinagawa-juku (å“å·å®¿)", distance:7.9},
  {name:"Kawasaki-juku (å·å´å®¿)", distance:17.7},
  {name:"Kanagawa-juku (ç¥å¥ˆå·å®¿)", distance:27.5},
  {name:"Hodogaya-juku (ç¨‹ãƒ¶è°·å®¿)", distance:32.4},
  {name:"Totsuka-juku (æˆ¸å¡šå®¿)", distance:41.2},
  {name:"Fujisawa-shuku (è—¤æ²¢å®¿)", distance:49.1},
  {name:"Hiratsuka-juku (å¹³å¡šå®¿)", distance:62.8},
  {name:"ÅŒiso-juku (å¤§ç£¯å®¿)", distance:65.8},
  {name:"Odawara-juku (å°ç”°åŸå®¿)", distance:81.5},
  {name:"Hakone-juku (ç®±æ ¹å®¿)", distance:98.1},
  {name:"Mishima-shuku (ä¸‰å³¶å®¿)", distance:112.9},
  {name:"Numazu-juku (æ²¼æ´¥å®¿)", distance:118.8},
  {name:"Hara-juku (åŸå®¿)", distance:124.7},
  {name:"Yoshiwara-juku (å‰åŸå®¿)", distance:136.5},
  {name:"Kanbara-juku (è’²åŸå®¿)", distance:147.7},
  {name:"Yui-shuku (ç”±æ¯”å®¿)", distance:151.6},
  {name:"Okitsu-juku (èˆˆæ´¥å®¿)", distance:160.8},
  {name:"Ejiri-juku (æ±Ÿå°»å®¿)", distance:164.9},
  {name:"FuchÅ«-shuku (åºœä¸­å®¿)", distance:175.5},
  {name:"Mariko-juku (é å­å®¿)", distance:181.2},
  {name:"Okabe-juku (å²¡éƒ¨å®¿)", distance:189.0},
  {name:"Fujieda-juku (è—¤æå®¿)", distance:195.8},
  {name:"Shimada-juku (å³¶ç”°å®¿)", distance:204.5},
  {name:"Kanaya-juku (é‡‘è°·å®¿)", distance:208.4},
  {name:"Nissaka-shuku (æ—¥å‚å®¿)", distance:215.0},
  {name:"Kakegawa-juku (æ›å·å®¿)", distance:222.1},
  {name:"Fukuroi-juku (è¢‹äº•å®¿)", distance:231.7},
  {name:"Mitsuke-juku (è¦‹é™„å®¿)", distance:237.6},
  {name:"Hamamatsu-juku (æµœæ¾å®¿)", distance:254.0},
  {name:"Maisaka-juku (èˆé˜ªå®¿)", distance:265.0},
  {name:"Arai-juku (æ–°å±…å®¿)", distance:270.8},
  {name:"Shirasuka-juku (ç™½é ˆè³€å®¿)", distance:277.4},
  {name:"Futagawa-juku (äºŒå·å®¿)", distance:283.2},
  {name:"Yoshida-juku (å‰ç”°å®¿)", distance:289.3},
  {name:"Goyu-shuku (å¾¡æ²¹å®¿)", distance:299.5},
  {name:"Akasaka-juku (èµ¤å‚å®¿)", distance:301.3},
  {name:"Fujikawa-shuku (è—¤å·å®¿)", distance:310.1},
  {name:"Okazaki-shuku (å²¡å´å®¿)", distance:316.8},
  {name:"ChiryÅ«-juku (æ± é¯‰é®’å®¿)", distance:331.8},
  {name:"Narumi-juku (é³´æµ·å®¿)", distance:342.9},
  {name:"Miya-juku (å®®å®¿)", distance:349.4},
  {name:"Kuwana-juku (æ¡‘åå®¿)", distance:376.9},
  {name:"Yokkaichi-juku (å››æ—¥å¸‚å®¿)", distance:389.6},
  {name:"Ishiyakushi-juku (çŸ³è–¬å¸«å®¿)", distance:400.4},
  {name:"ShÅno-juku (åº„é‡å®¿)", distance:403.1},
  {name:"Kameyama-juku (äº€å±±å®¿)", distance:411.0},
  {name:"Seki-juku (é–¢å®¿)", distance:416.9},
  {name:"Sakashita-juku (å‚ä¸‹å®¿)", distance:423.4},
  {name:"Tsuchiyama-juku (åœŸå±±å®¿)", distance:433.2},
  {name:"Minakuchi-juku (æ°´å£å®¿)", distance:443.8},
  {name:"Ishibe-juku (çŸ³éƒ¨å®¿)", distance:457.5},
  {name:"Kusatsu-juku (è‰æ´¥å®¿)", distance:469.3},
  {name:"ÅŒtsu-juku (å¤§æ´¥å®¿)", distance:483.7},
  {name:"SanjÅ ÅŒhashi (ä¸‰æ¡å¤§æ©‹)", distance:495.5}
];
const totalRouteKm = 495.5;

function getCombinedHistory(){
  const combined = {};
  for(const [day, record] of Object.entries(history)){
    combined[day] = {
      total: record.total,
      barefoot: record.barefoot,
      socks: record.socks
    };
  }
  if(running && sessionCount>0){
    const todayRecord = combined[todayKey] || {total:0,barefoot:0,socks:0};
    todayRecord.total += sessionCount;
    todayRecord.barefoot += sessionModeCounts.barefoot;
    todayRecord.socks += sessionModeCounts.socks;
    combined[todayKey] = todayRecord;
  }
  return combined;
}

/* ===== Camera ===== */
async function startCamera(){
  stream = await navigator.mediaDevices.getUserMedia({
    video:{ facingMode: document.getElementById("facing").value }
  });
  video.srcObject = stream;
  await new Promise(r => video.onloadedmetadata = r);
  await video.play();
}
function stopCamera(){
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
}

/* ===== Buttons ===== */
document.getElementById("startBtn").onclick = async()=>{
  if(!running){
    if(!model) model = await cocoSsd.load();
    await startCamera();
    running=true;
    sessionCount=0;
    sessionModeCounts={barefoot:0,socks:0};
    starTimes=[];
    countNow.textContent="Now: 0 / ç¾åœ¨: 0";
    if(intro) intro.style.display="none";
    logs.push("=== SESSION START ===");
    logModeChange();
    detectLoop();
    document.getElementById("startBtn").textContent="â¹ Stop / åœæ­¢";
  }else{
    running=false;
    stopCamera();
    const todayRecord = history[todayKey] || {total:0,barefoot:0,socks:0};
    todayRecord.total += sessionCount;
    todayRecord.barefoot += sessionModeCounts.barefoot;
    todayRecord.socks += sessionModeCounts.socks;
    history[todayKey] = todayRecord;
    localStorage.setItem("ankleHistory",JSON.stringify(history));
    logs.push("=== SESSION END ===");
    if(intro) intro.style.display="block";
    document.getElementById("startBtn").textContent="ğŸ“· Start Camera / ã‚«ãƒ¡ãƒ©èµ·å‹•";
  }
};

document.getElementById("hudBtn").onclick=()=>{
  hud.style.display = hud.style.display==="none"?"block":"none";
};

/* ===== HUD Copy ===== */
document.getElementById("copyHudBtn").onclick=async()=>{
  try{
    await navigator.clipboard.writeText(logs.join("\n"));
    logs.push("[HUD LOG COPIED]");
    hud.textContent=logs.join("\n");
  }catch(e){
    logs.push("[HUD COPY FAILED]");
  }
};

/* ===== Mode Toggle ===== */
document.getElementById("modeBtn").onclick=()=>{
  socksMode=!socksMode;
    document.getElementById("modeBtn").textContent =
      socksMode ? "ğŸ§¦ Socks / é´ä¸‹" : "ğŸ¦¶ Barefoot / è£¸è¶³";
  logModeChange();
};

const chartCanvas = document.getElementById("historyChart");
const chartCtx = chartCanvas.getContext("2d");
const graphMessage = document.getElementById("graphMessage");
const distanceMessage = document.getElementById("distanceMessage");
const startPointSelect = document.getElementById("startPointSelect");
document.getElementById("plotBtn").onclick=renderHistoryChart;
document.getElementById("distanceBtn").onclick=renderTokaidoSummary;

/* ===== å¹³å‡ãƒ†ãƒ³ãƒè¨ˆç®—ï¼ˆæ¸©å­˜ï¼‰ ===== */
function calculateAverageTempo(starTimes){
  if(starTimes.length < 3) return null;

  let intervals=[];
  for(let i=1;i<starTimes.length;i++){
    const dt=(starTimes[i]-starTimes[i-1])/1000;
    intervals.push(dt);
  }

  let blocks=[], current=[];
  for(const t of intervals){
    if(t>=0.5 && t<=2.0){
      current.push(t);
    }else{
      if(current.length>=2) blocks.push([...current]);
      current=[];
    }
  }
  if(current.length>=2) blocks.push([...current]);
  if(blocks.length===0) return null;

  const all = blocks.flat();
  const avgSec = all.reduce((a,b)=>a+b,0)/all.length;
  return (60/avgSec).toFixed(1);
}

/* ===== CSV ===== */
document.getElementById("csvBtn").onclick=()=>{
  status.textContent="CSVå‡ºåŠ›ã‚’æº–å‚™ã—ã¦ã„ã¾ã™â€¦";
  const csvTimeout = setTimeout(()=>{
    status.textContent="CSVå‡ºåŠ›ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™ã€‚ä¿å­˜åˆ¶é™ã‚„ãƒ¡ãƒ¢ãƒªãŒä¸è¶³ã—ã¦ã„ã‚‹ç«¯æœ«ã§ã¯ã€ç´™ã«æ—¥ä»˜ã¨å›æ•°ã‚’æ›¸ã„ã¦æ¬¡å›å—è¨ºã«ãŠæŒã¡ãã ã•ã„ã€‚";
  },15000);

  const exportHistory = getCombinedHistory();

  const rows = ["date,total,barefoot,socks"];
  const sortedDays = Object.keys(exportHistory).sort();
  for(const day of sortedDays){
    const record = exportHistory[day];
    rows.push(`${day},${record.total},${record.barefoot},${record.socks}`);
  }
  const csv = rows.join("\n");
  const dateStr = todayKey.replace(/-/g,"");
  const filename=`AnkleDorsiPlantarCounter_${dateStr}_summary.csv`;

  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=filename;
  try{
    a.click();
    status.textContent="CSVï¼ˆã¾ã¨ã‚ï¼‰ã‚’ç«¯æœ«ã«ä¿å­˜ã—ã¾ã—ãŸã€‚ä¿å­˜ä¸èƒ½ãªå ´åˆã¯ç´™ã«æ—¥ä»˜ã¨å›æ•°ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚";
  }catch(e){
    status.textContent="CSVå‡ºåŠ›ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ã“ã®ç«¯æœ«ã§ã¯ä¿å­˜ã§ããªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ç´™ã®ãƒ¡ãƒ¢ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚";
  }finally{
    clearTimeout(csvTimeout);
  }
};
function renderHistoryChart(){
  if(!chartCtx) return;
  const combined = getCombinedHistory();
  const days = Object.keys(combined).sort();
  if(days.length===0){
    chartCtx.clearRect(0,0,chartCanvas.width,chartCanvas.height);
    graphMessage.textContent="ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
    return;
  }

  const recentDays = days.slice(-7);
  const values = recentDays.map(day=>combined[day].total);
  const width = chartCanvas.width;
  const height = chartCanvas.height;
  const padding = 16;
  const maxValue = Math.max(...values,1);
  chartCtx.clearRect(0,0,width,height);
  chartCtx.fillStyle="#f6f6f6";
  chartCtx.fillRect(0,0,width,height);

  const barFullWidth = (width - padding*2) / recentDays.length;
  const barWidth = Math.max(12, barFullWidth * 0.7);

  for(let i=0;i<recentDays.length;i++){
    const val = values[i];
    const barHeight = (height - padding*2) * (val / maxValue);
    const x = padding + i * barFullWidth + (barFullWidth - barWidth)/2;
    const y = height - padding - barHeight;
    chartCtx.fillStyle="#4a90e2";
    chartCtx.fillRect(x, y, barWidth, barHeight);

    chartCtx.font="10px system-ui, sans-serif";
    chartCtx.textAlign="center";
    chartCtx.fillStyle="#333";
    chartCtx.fillText(recentDays[i].slice(5), x + barWidth/2, height - padding + 12);

    chartCtx.fillStyle="#111";
    chartCtx.fillText(val.toFixed(0), x + barWidth/2, y - 4);
  }
  const avg = (values.reduce((sum,v)=>sum+v,0)/values.length).toFixed(1);
  graphMessage.textContent=`ç›´è¿‘${recentDays.length}æ—¥å¹³å‡ ${avg}å›ã€æœ€æ–° ${recentDays[recentDays.length-1]} ${values[values.length-1]}å›`;
}

function renderTokaidoSummary(){
  const combined = getCombinedHistory();
  const days = Object.keys(combined);
  if(days.length===0){
    distanceMessage.textContent="ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
    return;
  }

  const totalCounts = days.reduce((sum,day)=>sum + combined[day].total,0);
  const distanceKm = totalCounts * 0.00045;
  const startPoint = startPointSelect.value;
  const station = findStationForDistance(distanceKm, startPoint);
  const startLabel = startPoint==="nihonbashi" ? "æ—¥æœ¬æ©‹" : "ä¸‰æ¡å¤§æ©‹";
  const stationLabel = station.name;
  const stationIndex = station.index+1;
  const avgPerDay = days.length ? (totalCounts/days.length).toFixed(1) : "0.0";
  let directionText;
  if(startPoint==="nihonbashi"){
    directionText = `${startLabel}ã‹ã‚‰ç´„${distanceKm.toFixed(2)}kmã§æ±æµ·é“53æ¬¡ ${stationIndex}ç•ªç›®ã®${stationLabel}ï¼ˆ${station.distance.toFixed(1)}kmåœ°ç‚¹ï¼‰ã«é”ã—ã¦ã„ã¾ã™ã€‚`;
  }else{
    const remaining = Math.max(0, totalRouteKm - station.distance);
    directionText = `${startLabel}ã‹ã‚‰ç´„${distanceKm.toFixed(2)}kmæ­©ãã¨æ±æµ·é“53æ¬¡ ${stationIndex}ç•ªç›®ã®${stationLabel}ï¼ˆæ®‹ã‚Š ${remaining.toFixed(1)}kmï¼‰ã«é”ã—ã¦ã„ã¾ã™ã€‚`;
  }
  distanceMessage.textContent=`ç´¯è¨ˆ ${totalCounts} å›ã€è¨˜éŒ²æ—¥æ•° ${days.length} æ—¥ã€1æ—¥å¹³å‡ ${avgPerDay} å›ã€‚${directionText}`;
}

function findStationForDistance(distanceKm, startPoint){
  if(distanceKm<=0){
    return {...tokaidoStations[0], index:0};
  }
  if(distanceKm>=totalRouteKm){
    return {...tokaidoStations[tokaidoStations.length-1], index:tokaidoStations.length-1};
  }
  if(startPoint==="nihonbashi"){
    let selected = tokaidoStations[0];
    for(let i=0;i<tokaidoStations.length;i++){
      if(distanceKm>=tokaidoStations[i].distance){
        selected={...tokaidoStations[i], index:i};
      }else{
        break;
      }
    }
    return selected;
  }
  const targetDistance = Math.max(0, totalRouteKm - distanceKm);
  let selected = tokaidoStations[tokaidoStations.length-1];
  for(let i=0;i<tokaidoStations.length;i++){
    if(targetDistance>=tokaidoStations[i].distance){
      selected={...tokaidoStations[i], index:i};
    }else{
      break;
    }
  }
  return selected;
}

renderHistoryChart();
renderTokaidoSummary();
  /* ===== detection loopï¼ˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ æ¸©å­˜ï¼‰ ===== */
async function detectLoop(){
  if(!running) return;

  if(logs.length===0){
    logs.push("detectLoop running...");
    hud.textContent=logs.join("\n");
  }

  const preds = await model.detect(video);
  const p = preds.find(x=>x.class==="person");

  if(p){
    const footY = p.bbox[1];
    const now = performance.now();
    const T = getThresholds();

    if(lastFootY!==null){
      const dY = footY-lastFootY;

      if(Math.abs(dY)<T.JUMP_CUT){
        const sign = dY>0?"+":dY<0?"-":"0";
        let mark="";

        if(!armed && Math.abs(dY)>=T.THRESH_ON && sign!=="0"){
          armed=true;
        }

        if(armed){
          const timeOK=(now-lastEventTime)>=LOCK_MS;
          const signOK=!lastSign||(sign!==lastSign&&sign!=="0");

          if(timeOK && signOK && Math.abs(dY)>=T.THRESH_ON){
            sessionCount++;
            const modeKey = socksMode ? "socks" : "barefoot";
            sessionModeCounts[modeKey]++;
            countNow.textContent="Now: "+sessionCount+" / ç¾åœ¨: "+sessionCount;
            lastEventTime=now;
            lastSign=sign;
            armed=false;
            mark=" â˜…";
            starTimes.push(now);
          }

          if(Math.abs(dY)<=T.THRESH_OFF){
            armed=false;
          }
        }

        const log=
          `t:${((now-lastEventTime)/1000).toFixed(1)}s  `+
          `footY:${footY.toFixed(0)}  `+
          `dY:${dY.toFixed(0)}  `+
          `sign:${sign}${mark}`;

        logs.push(log);
        if(logs.length>MAX_LOGS) logs.shift();
        hud.textContent=logs.join("\n");
      }
    }
    lastFootY=footY;
  }

  requestAnimationFrame(detectLoop);
}
</script>

</body>
</html>
